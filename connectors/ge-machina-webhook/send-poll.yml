workflow:

  name: send-poll
  title: "Send Poll to GE Machina Webhook"
  description: "Workflow to find the latest content-poll by event_code, send it to GE Machina webhook, and mark it as sent."
  context-variables:
    debugger:
      enabled: true
    ge-machina-webhook:
      basicAuth: "$TEMP_CONTEXT_VARIABLE_GE_MACHINA_WEBHOOK_API_KEY"
  inputs:
    event_code: "$.get('event_code')"
    poll_id: "$.get('poll_id')"
  outputs:
    workflow-status: "$.get('poll_found') is not True and 'skipped' or 'executed'"
    poll-sent: "$.get('webhook_success', False)"
    poll_id: "$.get('poll_id')"
  tasks:

    # load-poll-by-id
    - type: document
      name: load-poll-by-id
      description: "Load poll by ID if provided."
      condition: "$.get('poll_id') is not None"
      config:
        action: "search"
        search-limit: 1
        search-vector: false
      filters:
        document_id: "$.get('poll_id')"
      inputs:
        name: "{'$in': ['content-poll']}"
      outputs:
        event_code: "$.get('documents', [])[0].get('metadata', {}).get('event_code') if $.get('documents') else None"
        poll_found: "len($.get('documents', [])) > 0"
        poll_data: "$.get('documents', [])[0] if $.get('documents') else None"
        poll_id: "$.get('documents', [])[0].get('_id') if $.get('documents') else None"
        poll_metadata: "$.get('documents', [])[0].get('metadata', {}) if $.get('documents') else None"
        poll_value: "$.get('documents', [])[0].get('value', {}) if $.get('documents') else None"
        poll_created: "$.get('documents', [])[0].get('created') if $.get('documents') else None"
        poll_updated: "$.get('documents', [])[0].get('updated') if $.get('documents') else None"

    # load-latest-poll-by-event-code
    - type: document
      name: load-latest-poll-by-event-code
      description: "Fallback: Search for the latest content-poll by event_code."
      condition: "$.get('poll_found') is not True and $.get('event_code') is not None"
      config:
        action: "search"
        search-limit: 1
        search-vector: false
        search-sorters: ["created", -1]
      filters:
        metadata.event_code: "$.get('event_code')"
        value.sent: "{'$ne': True}"
      inputs:
        name: "{'$in': ['content-poll']}"
      outputs:
        poll_found: "len($.get('documents', [])) > 0"
        poll_data: "$.get('documents', [])[0] if $.get('documents') else None"
        poll_id: "$.get('documents', [])[0].get('_id') if $.get('documents') else None"
        poll_metadata: "$.get('documents', [])[0].get('metadata', {}) if $.get('documents') else None"
        poll_value: "$.get('documents', [])[0].get('value', {}) if $.get('documents') else None"
        poll_created: "$.get('documents', [])[0].get('created') if $.get('documents') else None"
        poll_updated: "$.get('documents', [])[0].get('updated') if $.get('documents') else None"

    # prepare-webhook-payload
    - type: mapping
      name: prepare-webhook-payload-poll
      condition: "$.get('poll_found') is True"
      inputs:
        poll_data: "$.get('poll_data')"
      outputs:
        webhook_payload: "$.get('webhook_payload')"

    # send-to-ge-machina-webhook
    - type: connector
      name: send-to-ge-machina-webhook
      condition: "$.get('poll_found') is True"
      connector:
        name: "ge-machina-webhook"
        command: "post-document/webhook"
      inputs:
        body: "$.get('webhook_payload')"
      outputs:
        webhook_response: "$"
        webhook_success: "$.get('status', 'false') == 'success'"
        webhook_status_code: "$.get('status_code', 0)"
        webhook_message: "$.get('message', '')"

    # update-snippet-as-sent
    - type: document
      name: update-poll-as-sent
      condition: "$.get('poll_found') is True and $.get('webhook_success') is True"
      config:
        action: "update"
        force-update: true
      document_id: "$.get('poll_id')"
      documents:
        content-poll: |
          {
            **$.get('poll_value', {}),
            "sent": True,
            "webhook_response": $.get('webhook_response', {})
          }
      metadata:
        event_code: "$.get('event_code')"